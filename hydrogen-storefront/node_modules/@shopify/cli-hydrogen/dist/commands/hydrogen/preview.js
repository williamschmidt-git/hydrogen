import Command from '@shopify/cli-kit/node/base-command';
import { muteDevLogs } from '../../lib/log.js';
import { getProjectPaths } from '../../lib/config.js';
import { commonFlags } from '../../lib/flags.js';
import { startMiniOxygen } from '../../lib/mini-oxygen.js';

class Preview extends Command {
  static description = "Runs a Hydrogen storefront in an Oxygen worker for production.";
  static flags = {
    path: commonFlags.path,
    port: commonFlags.port
  };
  async run() {
    const { flags } = await this.parse(Preview);
    await runPreview({ ...flags });
  }
}
async function runPreview({
  port,
  path: appPath
}) {
  if (!process.env.NODE_ENV)
    process.env.NODE_ENV = "production";
  muteDevLogs({ workerReload: false });
  const { root, buildPathWorkerFile, buildPathClient } = getProjectPaths(appPath);
  await startMiniOxygen({
    root,
    port,
    buildPathClient,
    buildPathWorkerFile
  });
}

export { Preview as default, runPreview };
